<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone.js Count-in Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        h1 {
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .input-group {
            margin-bottom: 30px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        input[type="number"] {
            padding: 15px;
            font-size: 1.5em;
            border: none;
            border-radius: 10px;
            width: 150px;
            text-align: center;
        }
        
        button {
            padding: 20px 40px;
            font-size: 1.3em;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 20px;
            font-size: 1.1em;
            min-height: 30px;
        }
        
        .info {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü•Å Tone.js Count-in Test</h1>
        
        <div class="input-group">
            <label for="bpmInput">BPM (Beats Per Minute)</label>
            <input type="number" id="bpmInput" value="120" min="40" max="240">
        </div>
        
        <button id="playBtn">‚ñ∂Ô∏è Play Count-in</button>
        
        <div class="status" id="status"></div>
        
        <div class="info">
            This will play 8 tick sounds (2 bars of 4/4 time).<br>
            Beats 1 and 5 will be accented with a higher pitch.<br>
            <strong>Test this on your iPhone to verify it works!</strong>
        </div>
    </div>

    <script>
        let synth = null;
        let isPlaying = false;

        // Initialize Tone.js synth
        function initSynth() {
            if (!synth) {
                // Create a simple synth for tick sounds
                synth = new Tone.Synth({
                    oscillator: {
                        type: 'sine'
                    },
                    envelope: {
                        attack: 0.001,
                        decay: 0.08,
                        sustain: 0,
                        release: 0.08
                    }
                }).toDestination();
            }
        }

        async function playCountIn() {
            const bpm = parseInt(document.getElementById('bpmInput').value);
            
            if (!bpm || bpm < 40 || bpm > 240) {
                document.getElementById('status').textContent = '‚ö†Ô∏è Please enter a valid BPM (40-240)';
                return;
            }

            if (isPlaying) return;
            
            isPlaying = true;
            const playBtn = document.getElementById('playBtn');
            playBtn.disabled = true;
            document.getElementById('status').textContent = 'üéµ Counting...';

            try {
                // Start Tone.js audio context (required for iOS)
                await Tone.start();
                console.log('Tone.js audio context started');

                // Initialize synth
                initSynth();

                // Calculate beat interval in seconds
                const beatInterval = 60 / bpm;

                // Schedule 8 ticks
                const now = Tone.now();
                
                for (let i = 0; i < 8; i++) {
                    const time = now + (i * beatInterval);
                    const isAccent = (i === 0 || i === 4);
                    
                    // Higher pitch for accented beats
                    const note = isAccent ? 'C6' : 'C5'; // C6 = ~1047Hz, C5 = ~523Hz
                    const duration = '32n'; // Short duration
                    
                    synth.triggerAttackRelease(note, duration, time);
                }

                // Re-enable button after all ticks complete
                const totalDuration = beatInterval * 8;
                setTimeout(() => {
                    isPlaying = false;
                    playBtn.disabled = false;
                    document.getElementById('status').textContent = '‚úÖ Count-in complete!';
                    
                    setTimeout(() => {
                        document.getElementById('status').textContent = '';
                    }, 2000);
                }, totalDuration * 1000 + 200);

            } catch (error) {
                console.error('Error playing count-in:', error);
                document.getElementById('status').textContent = '‚ùå Error: ' + error.message;
                isPlaying = false;
                playBtn.disabled = false;
            }
        }

        // Event listener
        document.getElementById('playBtn').addEventListener('click', playCountIn);

        // Allow Enter key to trigger play
        document.getElementById('bpmInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                playCountIn();
            }
        });
    </script>
</body>
</html>
